#!/bin/bash

if [ "$1" = "--mount-all" ]; then
	MOUNT=true
else
	if [ "$*" != 2 ]; then
		echo "Usage: $0 [ repotag srcpath restorepath ] | [ --mount-all ]" 2>&1
		exit 1
	fi
	REPOTAG="$1"; shift
	SRCPATH="$1"; shift
	RESTOREPATH="$1"; shift
	# TODO
	exit
fi

mkdir -p /mnt/restore

getvar_b() {
	perl -lne '/^borg_passphrase: .([\w\s]+)/ && print $1' ~glass/plug-services-secrets/group_vars/all
}

export BORG_REPO=ssh://19678@ch-s012.rsync.net:22/data2/home/19678/ruby/
export BORG_RSH="ssh -i /root/.ssh/borgkey"
export BORG_PASSPHRASE="$(getvar_b)"
set -x
borg mount $BORG_REPO /mnt/restore
for HOST in bayonet edison power; do
  ln -sf "$(find /mnt/restore -maxdepth 1 -name "${HOST}*"|sort -rn|head -1)" "/tmp/latest-$HOST"
done

rm /root/ldap-import
ln -s /tmp/latest-power/var/backups/slapd /root/ldap-import

set +x
